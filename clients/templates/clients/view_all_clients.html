{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>All Registered Clients</title>
    <link
      rel="icon"
      type="image/png"
      href="{% static 'images/logo-icon.png' %}"
    />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: "#5B21B6", dark: "#7C3AED" },
              accent: "#06b6d4",
              surface: { DEFAULT: "#fff", dark: "#18181b" },
            },
            boxShadow: {
              neu: "0 4px 24px 0 rgba(0,0,0,0.10), 0 1.5px 4px 0 rgba(91,33,182,0.10)",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
  </head>
  
  
    <a 
      href="{% url 'ceo_dashboard' %}" 
      class="fixed top-4 left-4 z-50 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow transition"
    >
      <i class="fa-solid fa-house mr-1"></i> Back Home
    </a>
    {% if messages %}
<<<<<<< HEAD
      <div id="popup-message-container" class="fixed top-8 left-1/2 transform -translate-x-1/2 z-50">
        {% for message in messages %}
        <div id="popup-message" class="mb-3 p-3 rounded-lg text-sm font-semibold shadow-lg transition-opacity duration-500
            {% if message.tags == 'success' %}bg-green-100 text-green-700
            {% elif message.tags == 'error' %}bg-red-100 text-red-700
            {% else %}bg-gray-100 text-gray-800{% endif %}">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      <script>
        window.addEventListener('DOMContentLoaded', function() {
          const popup = document.getElementById('popup-message');
          if (popup) {
            setTimeout(function() {
              popup.style.opacity = '0';
              popup.style.transition = 'opacity 0.5s';
              setTimeout(function() {
                popup.remove();
              }, 500);
            }, 2500);
          }
        });
      </script>
=======
        <div class="p-4 max-w-xl mx-auto">
      {% for message in messages %}
      <div class="mb-3 p-3 rounded-lg text-sm font-semibold
                  {% if message.tags == 'success' %}bg-green-100 text-green-700
                  {% elif message.tags == 'error' %}bg-red-100 text-red-700
                  {% else %}bg-gray-100 text-gray-800{% endif %}">
        {{ message }}
      </div>
      {% endfor %}
        </div>
>>>>>>> e6bd43f81386a48e87fa5a3df4830c1ab872c271
    {% endif %}

  <body
    class="bg-gradient-to-bl from-primary/10 via-accent/10 to-slate-100 dark:from-surface-dark dark:via-primary-dark/10 dark:to-surface-dark min-h-screen p-6 transition-colors duration-300"
  >
    <div
      id="preloader"
      class="fixed inset-0 flex items-center justify-center bg-blue z-50"
    >
      <img
        src="{% static 'images/logo.png' %}"
        alt="Company Logo"
        class="animate-spin w-20 h-20"
      />
    </div>

    <section
      class="w-full max-w-6xl mx-auto bg-white dark:bg-surface-dark shadow-neu rounded-3xl p-8 md:p-10"
    >
      <h1
        class="text-3xl font-bold text-primary dark:text-accent mb-6 flex items-center gap-2"
      >
        <i class="fa-solid fa-address-book"></i>
        All Registered Clients
      </h1>

      <div class="mb-4">
        <input
          type="text"
          id="searchNRC"
          placeholder="Search by NRC..."
          class="w-full md:w-1/3 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"
        />
      </div>

      <div
        class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-800 shadow"
      >
        <table
          class="min-w-full text-sm text-left text-gray-700 dark:text-gray-200"
        >
          <thead
            class="bg-gray-100 dark:bg-surface-dark text-gray-600 dark:text-gray-300 uppercase text-xs"
          >
            <tr>
              <th class="px-4 py-3">Name</th>
              <th class="px-4 py-3">NRC</th>
              <th class="px-4 py-3">Phone</th>
            <th class="px-4 py-3">Created At</th>
            <th class="px-4 py-3">Officer</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3 text-center">Actions</th>
          </tr>
          <tr>
            <td colspan="6" class="px-4 py-3">
              <form method="get" id="filterForm" class="flex items-center gap-4">
                <select name="officer" onchange="document.getElementById('filterForm').submit()" class="form-select px-3 py-2 rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
                  <option value="">All Officers</option>
                  {% for officer in officers %}
                    <option value="{{ officer.id }}" {% if form.officer.value == officer.id|stringformat:"s" %}selected{% endif %}>
                      {{ officer.get_full_name|default:officer.username }}
                    </option>
                  {% endfor %}
                </select>
<<<<<<< HEAD
                  <!-- Status Filter Buttons -->
                  <input type="hidden" name="status" id="statusInput" value="{{ request.GET.status|default:'' }}" />
                  <button type="button" onclick="setStatusFilter('pending')" class="px-4 py-2 rounded-lg font-semibold bg-yellow-500 text-white hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 {% if request.GET.status == 'pending' %}ring-2 ring-yellow-400{% endif %}">Pending</button>
                  <button type="button" onclick="setStatusFilter('approved')" class="px-4 py-2 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 {% if request.GET.status == 'approved' %}ring-2 ring-green-400{% endif %}">Approved</button>
                  <button type="button" onclick="setStatusFilter('')" class="px-4 py-2 rounded-lg font-semibold bg-gray-300 text-gray-800 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 {% if not request.GET.status %}ring-2 ring-gray-400{% endif %}">All</button>
=======
>>>>>>> e6bd43f81386a48e87fa5a3df4830c1ab872c271
              </form>
            </td>
          </tr>
          </thead>
          <tbody id="clientTableBody">
            {% for client in clients %}
            <tr
              class="border-t border-gray-100 dark:border-gray-800 hover:bg-primary/5 dark:hover:bg-accent/10"
            >
              <td class="px-4 py-3 font-semibold">{{ client.full_name }}</td>
              <td class="px-4 py-3">{{ client.nrc }}</td>
              <td class="px-4 py-3">{{ client.phone_number }}</td>
              <td class="px-4 py-3">{{ client.created_at|date:"M d, Y" }}</td>
              <td class="px-4 py-3">{{ client.created_by.get_full_name|default:client.created_by.username }}</td>
              <td class="px-4 py-3">
                {% if client.approved %}
                  <span class="inline-block px-2 py-1 text-green-700 bg-green-100 dark:bg-green-900 dark:text-green-300 rounded-full text-xs font-medium">
                    Approved
                  </span>
                {% elif client.rejected %}
                  <span class="inline-block px-2 py-1 text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-300 rounded-full text-xs font-medium">
                    Rejected
                  </span>
                {% else %}
                  <span class="inline-block px-2 py-1 text-yellow-700 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-300 rounded-full text-xs font-medium">
                    Pending
                  </span>
                {% endif %}
              </td>

<<<<<<< HEAD
              <!-- <td class="px-4 py-3 text-center relative">
                <div class="relative inline-block text-left">
                    <button onclick="openActionModal('{{ client.id }}')"
=======
              <td class="px-4 py-3 text-center relative">
                <div class="relative inline-block text-left">
                  <button onclick="toggleActionMenu({{ client.id }})"
>>>>>>> e6bd43f81386a48e87fa5a3df4830c1ab872c271
                    class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white px-3 py-1 rounded-lg text-xs font-semibold">
                    Actions <i class="fa-solid fa-chevron-down text-[10px] ml-1"></i>
                  </button>

<<<<<<< HEAD
                </div>
              </td> -->
              <td class="px-4 py-3 text-center">
                <button onclick="openActionModal('{{ client.id }}')"
                  class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white px-3 py-1 rounded-lg text-xs font-semibold">
                  Actions <i class="fa-solid fa-bars text-[13px] ml-1"></i>
                </button>
              </td>
    <!-- Action Modal -->
    <div id="actionModal" class="fixed inset-0 z-50 bg-black/50 hidden items-center justify-center px-4">
      <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-neu max-w-xs w-full p-6 relative">
        <button id="closeActionModal" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
          <i class="fa-solid fa-times"></i>
        </button>
        <h2 class="text-lg font-bold mb-4 text-primary dark:text-accent flex items-center gap-2">
          <i class="fa-solid fa-bars"></i> Client Actions
        </h2>
        <div id="actionModalContent"></div>
      </div>
    </div>
    <script>
      function openActionModal(clientId) {
        const modal = document.getElementById("actionModal");
        const content = document.getElementById("actionModalContent");
        // Find the client row in the table
        const clientRow = document.querySelector(`button[onclick="openActionModal('${clientId}')"]`).closest('tr');
        // Get approval status
        const approved = clientRow.querySelector(".text-green-700") !== null;
        const rejected = clientRow.querySelector(".text-red-700") !== null;
        let html = `
          <button onclick="openViewModal('${clientId}')" class="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-700 dark:hover:text-white mb-1">
            <i class='fa-solid fa-eye mr-1'></i> View
          </button>
          <button onclick="openEditModal('${clientId}')" class="w-full text-left px-4 py-2 text-sm text-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-700 dark:hover:text-white mb-1">
            <i class='fa-solid fa-pen mr-1'></i> Edit
          </button>
          <button onclick="confirmDeleteClient('${clientId}')" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-700 dark:hover:text-white mb-1">
            <i class='fa-solid fa-trash mr-1'></i> Delete
          </button>
        `;
        if (!approved && !rejected) {
          html += `
            <form method='POST' action='/clients/approve/${clientId}/'>
              <input type='hidden' name='csrfmiddlewaretoken' value='${document.querySelector('[name=csrfmiddlewaretoken]').value}'>
              <button type='submit' class='w-full text-left px-4 py-2 text-sm text-green-600 hover:bg-green-50 dark:hover:bg-green-700 dark:hover:text-white mb-1'>
                <i class='fa-solid fa-check mr-1'></i> Approve
              </button>
            </form>
            <form method='POST' action='/clients/reject/${clientId}/'>
              <input type='hidden' name='csrfmiddlewaretoken' value='${document.querySelector('[name=csrfmiddlewaretoken]').value}'>
              <button type='submit' class='w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-700 dark:hover:text-white mb-1'>
                <i class='fa-solid fa-xmark mr-1'></i> Reject
              </button>
            </form>
          `;
        }
        content.innerHTML = html;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      document.getElementById("closeActionModal").onclick = function() {
        document.getElementById("actionModal").classList.add("hidden");
        document.getElementById("actionModal").classList.remove("flex");
      };
      window.addEventListener("click", function(e) {
        const modal = document.getElementById("actionModal");
        if (e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      });
    </script>
=======
                  <div id="actionMenu-{{ client.id }}"
                    class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-900 shadow-lg rounded-lg border dark:border-gray-700 z-50">
                    
                    <button onclick="openViewModal({{ client.id }})"
                      class="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-700 dark:hover:text-white">
                      <i class="fa-solid fa-eye mr-1"></i> View
                    </button>
                    
                    <button onclick="openEditModal({{ client.id }})"
                      class="w-full text-left px-4 py-2 text-sm text-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-700 dark:hover:text-white">
                      <i class="fa-solid fa-pen mr-1"></i> Edit
                    </button>
                    
                    <button onclick="confirmDeleteClient({{ client.id }})"
                      class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-700 dark:hover:text-white">
                      <i class="fa-solid fa-trash mr-1"></i> Delete
                    </button>

                    {% if not client.approved and not client.rejected %}
                      <form method="POST" action="{% url 'approve_client' client.id %}">
                        {% csrf_token %}
                        <button type="submit"
                          class="w-full text-left px-4 py-2 text-sm text-green-600 hover:bg-green-50 dark:hover:bg-green-700 dark:hover:text-white">
                          <i class="fa-solid fa-check mr-1"></i> Approve
                        </button>
                      </form>
                      <form method="POST" action="{% url 'reject_client' client.id %}">
                        {% csrf_token %}
                        <button type="submit"
                          class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-700 dark:hover:text-white">
                          <i class="fa-solid fa-xmark mr-1"></i> Reject
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              </td>
>>>>>>> e6bd43f81386a48e87fa5a3df4830c1ab872c271
            </tr>
            {% empty %}
            <tr>
              <td
                colspan="5"
                class="px-4 py-6 text-center text-gray-400 dark:text-gray-500"
              >
                No clients found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
<<<<<<< HEAD
      <script>
        function setStatusFilter(status) {
          document.getElementById('statusInput').value = status;
          document.getElementById('filterForm').submit();
        }
      </script>
=======
>>>>>>> e6bd43f81386a48e87fa5a3df4830c1ab872c271
    <script>
      document.getElementById("searchNRC").addEventListener("input", function () {
        const query = this.value.trim();

        fetch(`/clients/search/?nrc=${query}`)
          .then((response) => response.json())
          .then((data) => {
            const tbody = document.getElementById("clientTableBody");
            tbody.innerHTML = "";

            if (data.clients.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="6" class="text-center text-gray-400 py-6">No clients found.</td>
                </tr>`;
              return;
            }

            data.clients.forEach((client) => {
              tbody.innerHTML += `
                <tr class="border-t border-gray-100 dark:border-gray-800 hover:bg-primary/5 dark:hover:bg-accent/10">
                  <td class="px-4 py-3 font-semibold">${client.full_name}</td>
                  <td class="px-4 py-3">${client.nrc}</td>
                  <td class="px-4 py-3">${client.phone_number}</td>
                  <td class="px-4 py-3">${client.created_at}</td>
                  <td class="px-4 py-3">
                    ${client.approved ? `
                      <span class="inline-block px-2 py-1 text-green-700 bg-green-100 dark:bg-green-900 dark:text-green-300 rounded-full text-xs font-medium">
                        Approved
                      </span>
                    ` : `
                      <form method="POST" action="/clients/approve/${client.id}/">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${data.csrf_token}">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-xs font-semibold">
                          Approve
                        </button>
                      </form>
                    `}
                  </td>
                  <td class="px-4 py-3 text-center">
                    <div class="flex items-center justify-center gap-2">
                      <button class="bg-blue-600 text-white px-3 py-1 rounded text-xs" onclick="openViewModal(${client.id})">
                        <i class="fa-solid fa-eye"></i> View
                      </button>
                      <button class="bg-yellow-500 text-white px-3 py-1 rounded text-xs" onclick="openEditModal(${client.id})">
                        <i class="fa-solid fa-pen"></i> Edit
                      </button>
                      <button class="bg-red-600 text-white px-3 py-1 rounded text-xs" onclick="confirmDeleteClient(${client.id})">
                        <i class="fa-solid fa-trash"></i> Delete
                      </button>
                    </div>
                  </td>
                </tr>`;
            });
          });
      });
    </script>

    <script>
      function openViewModal(clientId) {
        const modal = document.getElementById("viewModal");
        const content = document.getElementById("modalContent");
        modal.classList.remove("hidden");
        content.innerHTML = "<p class='text-sm'>Loading...</p>";

        fetch(`/clients/api/details/${clientId}/`)
          .then((res) => res.json())
          .then((data) => {
            let loanHtml = "";

            if (data.loans.length === 0) {
              loanHtml = `<p class="text-gray-500 dark:text-gray-400">No loans found for this client.</p>`;
            } else {
              data.loans.forEach((loan, index) => {
                const statusBadge = loan.is_settled
                  ? `<span class="inline-block px-3 py-1 bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 rounded-full">Settled</span>`
                  : `<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300 rounded-full">ZMW ${loan.balance.toFixed(
                      2
                    )} remaining</span>`;

                loanHtml += `
              <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4">
                <p><strong>Loan #${index + 1}</strong></p>
                <p><strong>Base Amount:</strong> ZMW ${loan.original_amount.toFixed(2)}</p>
                <p><strong>Total with Interest (37.8%):</strong> ZMW ${loan.amount.toFixed(2)}</p>
                <p><strong>Approved:</strong> ${
                  loan.approved ? "Yes" : "No"
                }</p>
                <p><strong>Created At:</strong> ${loan.created_at}</p>
                <p><strong>Due Date:</strong> ${loan.due_date}</p>
                <p><strong>Status:</strong> ${statusBadge}</p>

                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mt-2">
                  <div class="bg-green-500 h-4 rounded-full" style="width: ${Math.min(
                    (loan.total_paid / loan.amount) * 100,
                    100
                  )}%"></div>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  ZMW ${loan.total_paid.toFixed(
                    2
                  )} of ZMW ${loan.amount.toFixed(2)} paid
                </p>
              </div>
            `;
              });
            }

            content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p><strong>Full Name:</strong> ${data.full_name}</p>
              <p><strong>NRC:</strong> ${data.nrc}</p>
              <p><strong>Phone:</strong> ${data.phone_number}</p>
              <p><strong>Registered:</strong> ${data.created_at}</p>
            </div>
          </div>
          <hr class="my-4 border-gray-300 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-primary dark:text-accent mb-2">Loan History</h3>
          ${loanHtml}
        `;
          })
          .catch(() => {
            content.innerHTML =
              "<p class='text-red-500'>Failed to load client details.</p>";
          });
      }

      function closeViewModal() {
        document.getElementById("viewModal").classList.add("hidden");
      }
    </script>
    <script>
      function toggleActionMenu(clientId) {
        // Close other open menus
        document.querySelectorAll("[id^='actionMenu-']").forEach(menu => {
          if (menu.id !== `actionMenu-${clientId}`) menu.classList.add('hidden');
        });

        const menu = document.getElementById(`actionMenu-${clientId}`);
        menu.classList.toggle("hidden");
      }

      // Close menus when clicking outside
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".relative")) {
          document.querySelectorAll("[id^='actionMenu-']").forEach(menu => menu.classList.add('hidden'));
        }
      });
    </script>


    <script>
      window.addEventListener("load", function () {
        const preloader = document.getElementById("preloader");
        if (preloader) {
          preloader.style.opacity = "0";
          preloader.style.visibility = "hidden";
          preloader.style.transition = "opacity 0.5s ease";

          // Optionally, remove from DOM after transition ends
          setTimeout(() => preloader.remove(), 600);
        }
      });
    </script>
    <!-- View More Modal -->
    <div
      id="viewModal"
      class="fixed inset-0 z-50 bg-black/50 hidden items-center justify-center px-4"
    >
      <div
        class="bg-white dark:bg-surface-dark rounded-2xl shadow-neu max-w-2xl w-full p-6 md:p-8 relative overflow-y-auto max-h-[90vh]"
      >
        <button
          onclick="closeViewModal()"
          class="absolute top-3 right-4 text-gray-400 hover:text-red-500"
        >
          <i class="fa-solid fa-times"></i>
        </button>
        <h2
          class="text-xl font-bold mb-4 text-primary dark:text-accent flex items-center gap-2"
        >
          <i class="fa-solid fa-user-circle"></i> Client Details
        </h2>
        <div
          id="modalContent"
          class="text-sm space-y-4 text-gray-700 dark:text-gray-200"
        >
          <p>Loading...</p>
        </div>
      </div>
    </div>

    <!-- Edit Client Modal -->
    <div
      id="editModal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4"
    >
      <div
        class="bg-white dark:bg-surface-dark rounded-2xl shadow-neu max-w-3xl w-full p-6 md:p-8 relative overflow-y-auto max-h-[90vh]"
      >
        <button
          onclick="closeEditModal()"
          class="absolute top-3 right-4 text-gray-400 hover:text-red-500"
        >
          <i class="fa-solid fa-times"></i>
        </button>

        <h2
          class="text-xl font-bold mb-4 text-primary dark:text-accent flex items-center gap-2"
        >
          <i class="fa-solid fa-pen"></i> Edit Client Info
        </h2>

        <form
          id="editClientForm"
          method="POST"
          enctype="multipart/form-data"
          action="{% url 'update_client' %}"
        >
          {% csrf_token %}
          <input type="hidden" name="client_id" id="editClientId" />

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Personal Info -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Full Name</label>
              <input
                type="text"
                name="full_name"
                id="editFullName"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">NRC</label>
              <input
                type="text"
                name="nrc"
                id="editNrc"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Phone Number</label>
              <input
                type="text"
                name="phone_number"
                id="editPhone"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Business Name</label>
              <input
                type="text"
                name="business_name"
                id="editBusinessName"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Address</label>
              <textarea
                name="address"
                id="editAddress"
                class="w-full p-2 border rounded"
                rows="3"
              ></textarea>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Marital Status</label>
              <select
                name="marital_status"
                id="editMaritalStatus"
                class="w-full p-2 border rounded"
              >
                <option value="">Select</option>
                <option value="single">Single</option>
                <option value="married">Married</option>
                <option value="divorced">Divorced</option>
                <option value="widowed">Widowed</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Relationship with Witness</label>
              <input
                type="text"
                name="relationship_with_witness"
                id="editRelationshipWithWitness"
                class="w-full p-2 border rounded"
              />
            </div>

            <!-- Passport Photo -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Passport Photo</label>
              <input
                type="file"
                name="passport_photo"
                id="editPassportPhoto"
                class="w-full p-2 border rounded text-gray-700 dark:text-gray-200"
              />
              <img
                id="previewPassport"
                class="w-24 h-24 mt-2 rounded object-cover"
                src=""
                alt="Preview"
              />
            </div>

            <!-- Signature -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Signature</label>
              <input
                type="file"
                name="signature"
                id="editSignature"
                class="w-full p-2 border rounded text-gray-700 dark:text-gray-200"
              />
              <img
                id="previewSignature"
                class="w-24 h-24 mt-2 rounded object-cover"
                src=""
                alt="Preview"
              />
            </div>
          </div>

          <hr class="my-4" />

          <!-- Surety Info -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Surety Name</label>
              <input
                type="text"
                name="surety_name"
                id="editSuretyName"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Surety Value</label>
              <input
                type="number"
                step="0.01"
                name="surety_value"
                id="editSuretyValue"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Surety Make</label>
              <input
                type="text"
                name="surety_make"
                id="editSuretyMake"
                class="w-full p-2 border rounded"
              />
            </div>
          </div>

          <hr class="my-4" />

          <!-- Witness Info -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Witness Name</label>
              <input
                type="text"
                name="witness_name"
                id="editWitnessName"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Witness NRC</label>
              <input
                type="text"
                name="witness_nrc"
                id="editWitnessNrc"
                class="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200">Witness Phone</label>
              <input
                type="text"
                name="witness_phone"
                id="editWitnessPhone"
                class="w-full p-2 border rounded"
              />
            </div>
          </div>

          <div class="mt-6 flex justify-end">
            <button
              type="submit"
              class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark"
            >
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div
      id="deleteConfirmModal"
      class="fixed inset-0 z-50 bg-black/50 hidden items-center justify-center px-4"
    >
      <div
        class="bg-white dark:bg-surface-dark rounded-2xl shadow-neu max-w-md w-full p-6 relative"
      >
        <button
          onclick="closeDeleteModal()"
          class="absolute top-3 right-4 text-gray-400 hover:text-red-500"
        >
          <i class="fa-solid fa-times"></i>
        </button>
        <h2
          class="text-xl font-bold mb-4 text-red-600 dark:text-red-400 flex items-center gap-2"
        >
          <i class="fa-solid fa-trash"></i> Confirm Delete
        </h2>
        <p class="mb-4 text-gray-700 dark:text-gray-300">
          Are you sure you want to delete this client? This action cannot be
          undone.
        </p>
        <div class="flex justify-end gap-2">
          <button
            onclick="closeDeleteModal()"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg"
          >
            Cancel
          </button>
          <button
            id="confirmDeleteBtn"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
    <script>
      let deleteClientId = null;

      function confirmDeleteClient(clientId) {
        deleteClientId = clientId;
        document
          .getElementById("deleteConfirmModal")
          .classList.remove("hidden");
      }

      function closeDeleteModal() {
        deleteClientId = null;
        document.getElementById("deleteConfirmModal").classList.add("hidden");
      }

      document
        .getElementById("confirmDeleteBtn")
        .addEventListener("click", function () {
          if (!deleteClientId) return;

          fetch(`/clients/api/delete/${deleteClientId}/`, {
            method: "DELETE",
            headers: {
              "X-CSRFToken": getCSRFToken(),
            },
          })
            .then((res) => {
              if (!res.ok) throw new Error("Failed to delete");
              return res.json();
            })
            .then((data) => {
              if (data.success) {
                closeDeleteModal();
                // Option 1: reload page
                window.location.reload();

                // Option 2: OR remove the row (if you want a smoother UX)
                // document.querySelector(`[data-client-id="${deleteClientId}"]`).remove();
              } else {
                alert("Failed to delete client.");
              }
            })
            .catch(() => {
              alert("Error deleting client.");
              closeDeleteModal();
            });
        });

      function getCSRFToken() {
        return document.querySelector("[name=csrfmiddlewaretoken]").value;
      }
    </script>

    <script>
      function openEditModal(clientId) {
        const modal = document.getElementById("editModal");
        modal.classList.remove("hidden");
        document.getElementById("editClientId").value = clientId;

        fetch(`/clients/api/edit/${clientId}/`)
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("editFullName").value = data.full_name;
            document.getElementById("editNrc").value = data.nrc;
            document.getElementById("editPhone").value = data.phone_number;
            document.getElementById("editBusinessName").value = data.business_name || '';
            document.getElementById("editAddress").value = data.address || '';
            document.getElementById("editMaritalStatus").value = data.marital_status || '';
            document.getElementById("editRelationshipWithWitness").value = data.relationship_with_witness || '';
            document.getElementById("editSuretyName").value = data.surety_name;
            document.getElementById("editSuretyValue").value = data.surety_value || '';
            document.getElementById("editSuretyMake").value = data.surety_make || '';
            document.getElementById("editWitnessName").value =
              data.witness_name;
            document.getElementById("editWitnessNrc").value = data.witness_nrc;
            document.getElementById("editWitnessPhone").value =
              data.witness_phone;

            document.getElementById("previewPassport").src =
              data.passport_photo;
            document.getElementById("previewSignature").src = data.signature;
          })
          .catch((err) => {
            alert("Failed to fetch client data.");
            closeEditModal();
          });
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
      }
    </script>
    <script>
      function toggleActionMenu(id) {
        const menu = document.getElementById(`actionMenu-${id}`);
        const allMenus = document.querySelectorAll("[id^='actionMenu-']");

        allMenus.forEach(m => {
          if (m !== menu) m.classList.add("hidden");
        });

        menu.classList.toggle("hidden");
      }

      // Close menu if clicked outside
      window.addEventListener('click', function (e) {
        document.querySelectorAll("[id^='actionMenu-']").forEach(menu => {
          if (!menu.contains(e.target) && !e.target.closest("button[onclick^='toggleActionMenu']")) {
            menu.classList.add("hidden");
          }
        });
      });
    </script>
  </body>
</html>
